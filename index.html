<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>Berkshire Clinics and Clients Map</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">

  <!-- Leaflet + Geocoder -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
  <link rel="stylesheet" href="https://unpkg.com/leaflet-control-geocoder/dist/Control.Geocoder.css" />
  <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
  <script src="https://unpkg.com/papaparse@5.4.1/papaparse.min.js"></script>
  <script src="https://unpkg.com/leaflet-control-geocoder/dist/Control.Geocoder.js"></script>

  <style>
    html, body, #map { height: 100%; margin: 0; }
    .legend {
      background: white;
      padding: 6px 8px;
      font: 14px/16px Arial;
      border-radius: 5px;
      box-shadow: 0 0 10px rgba(0,0,0,0.2);
      line-height: 18px;
    }
    .legend i {
      width: 12px;
      height: 12px;
      float: left;
      margin-right: 8px;
      opacity: 0.8;
    }
    #controls {
      position: absolute;
      top: 10px;
      left: 50%;
      transform: translateX(-50%);
      background: white;
      z-index: 1000;
      padding: 8px 12px;
      border-radius: 8px;
      box-shadow: 0 2px 6px rgba(0,0,0,0.3);
      font-family: Arial;
    }
    #controls label { margin: 0 5px; }
    #controls select, #controls input, #controls button {
      margin-right: 8px;
      font-size: 13px;
    }
  </style>
</head>
<body>
  <!-- Filter Controls -->
  <div id="controls">
    <label>From:</label>
    <input type="date" id="startDate">
    <label>To:</label>
    <input type="date" id="endDate">
    <label>PCT:</label>
    <select id="pctFilter">
      <option value="All Regions">All Regions</option>
      <option value="Bracknell">Bracknell</option>
      <option value="Reading">Reading</option>
      <option value="West Berkshire">West Berkshire</option>
      <option value="Windsor Ascot And Maidenhead">Windsor Ascot And Maidenhead</option>
      <option value="Wokingham">Wokingham</option>
    </select>
    <button id="applyFilters">Apply</button>
  </div>

  <!-- Map -->
  <div id="map"></div>

  <script>
  // --- Initialize map ---
  const map = L.map('map').setView([51.45, -0.85], 10);
  L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
    attribution: '&copy; OpenStreetMap contributors'
  }).addTo(map);

  // --- Add search bar ---
  L.Control.geocoder({
    defaultMarkGeocode: true,
    placeholder: "Search towns or postcodes...",
    collapsed: false
  }).addTo(map);

  // --- Layer groups ---
  const clientLayer = L.layerGroup().addTo(map);
  const clinicLayer = L.layerGroup().addTo(map);

  // --- API credentials and URL ---
const API_URL = "/api/clients";

const url = `${API_URL}?pct=${pct}&from_date=${start}&to_date=${end}`;
const res = await fetch(url);

  // --- Load CLINICS (static once) ---
  async function loadClinics() {
    const res = await fetch("data/clinics_geo.csv"); // still local for now
    const csv = await res.text();
    const data = Papa.parse(csv, { header: true }).data;
    data.forEach(row => {
      if (row.latitude && row.longitude) {
        const isGP = row.type?.toLowerCase() === "gp";
        const color = isGP ? "#e60026" : "#6a0dad";
        const label = isGP ? "GP Surgery" : "Clinic";

        const marker = L.circleMarker([+row.latitude, +row.longitude], {
          radius: 7,
          color,
          fillColor: color,
          fillOpacity: 0.9,
          weight: 1
        }).bindTooltip(
          `<b>${row.name}</b><br>${label}<br>${row.postcode}`,
          { permanent: false, direction: "top", offset: [0, -5] }
        );
        marker.addTo(clinicLayer);
      }
    });
  }

  loadClinics(); // run once

  // --- Fetch clients from API ---
  async function loadClients() {
    const start = document.getElementById("startDate").value || "2023-01-01";
    const end = document.getElementById("endDate").value || "2025-11-13";
    const pct = document.getElementById("pctFilter").value || "All Regions";

    const url = `${API_URL}?from_date=${start}&to_date=${end}&pct=${encodeURIComponent(pct)}`;

    const res = await fetch(url, {
      headers: {
        "Authorization": "Basic " + btoa(`${API_USER}:${API_PASS}`)
      }
    });

    if (!res.ok) {
      alert("Error fetching data: " + res.status);
      return;
    }

    const geojson = await res.json();
    renderClients(geojson.features);
  }

  // --- Render clients on the map ---
  function renderClients(features) {
    clientLayer.clearLayers();
    features.forEach(f => {
      const [lon, lat] = f.geometry.coordinates;
      const p = f.properties;

      const marker = L.circleMarker([lat, lon], {
        radius: 4,
        color: "#0077ff",
        fillColor: "#0077ff",
        fillOpacity: 0.8,
        weight: 1
      }).bindPopup(
        `<b>Client</b><br>Postcode: ${p.postcode || "N/A"}<br>PCT: ${p.pct}<br>Date: ${p.date}<br>ID: ${p.clientid}`
      );
      marker.addTo(clientLayer);
    });
  }

  // --- Apply Filters button ---
  document.getElementById("applyFilters").addEventListener("click", loadClients);

  // --- Initial load ---
  loadClients();

  // --- Legend ---
  const legend = L.control({ position: "bottomright" });
  legend.onAdd = function () {
    const div = L.DomUtil.create("div", "legend");
    div.innerHTML = `
      <i style="background:#e60026"></i> GP Surgeries<br>
      <i style="background:#6a0dad"></i> Clinics<br>
      <i style="background:#0077ff"></i> Clients
    `;
    return div;
  };
  legend.addTo(map);
</script>
</body>
</html>